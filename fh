#!/usr/bin/env bash
# shellcheck disable=SC2016,SC2154
# fh — scaffold a small nix flake dev project
#
# Usage:
#   fh <dir>                    # default flake
#   fh rust <dir>               # rust flake
#   fh wasm <dir>               # wasm flake
#
# Options:
#   --no-git    : skip git init / commit
#   --force     : allow non-empty directory

set -euo pipefail

usage() {
  cat <<EOF >&2
usage: fh <rust|wasm|default> <dir> [--no-git] [--force]
EOF
  exit 1
}

if [ "$#" -lt 1 ]; then usage; fi

if [ "$#" -eq 1 ]; then
  LANG="default"
  DIR="$1"
else
  LANG="$1"
  DIR="$2"
fi

shift $(( $# > 1 ? 2 : 1 ))

NO_GIT=0
FORCE=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-git) NO_GIT=1 ;;
    --force) FORCE=1 ;;
    -h|--help) usage ;;
    *) echo "Unknown option: $1" >&2; usage ;;
  esac
  shift
done

mkdir -p "$DIR"

if [ "$FORCE" -ne 1 ] && [ "$(find "$DIR" -mindepth 1 -maxdepth 1 | wc -l)" -gt 0 ]; then
  echo "Directory '$DIR' is not empty. Use --force to continue." >&2
  exit 1
fi

cd "$DIR"

proj_base="$(basename "$DIR")"
proj_name="$(printf '%s' "$proj_base" \
  | iconv -f utf8 -t ascii//TRANSLIT 2>/dev/null || true)"
proj_name="$(printf '%s' "$proj_name" \
  | tr '[:upper:]' '[:lower:]' \
  | sed -E 's/[^a-z0-9]+/-/g; s/^-|-$//g')"

if [ -z "$proj_name" ]; then
  echo "Invalid project name derived from '$DIR'" >&2
  exit 1
fi

write_shell_hook_ps1='
if [ -n "''${FH_PS1-}" ]; then
  export PS1="$FH_PS1"
fi
'

write_flake_default() {
  cat > flake.nix <<EOF
{
  description = "${proj_name} flake";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils, ... }:
    flake-utils.lib.eachDefaultSystem (system:
      let pkgs = nixpkgs.legacyPackages.\${system};
      in {
        devShells.default = pkgs.mkShell {
          packages = with pkgs; [ ];
          shellHook = ''
            ${write_shell_hook_ps1}
          '';
        };
      }
    );
}
EOF
}

write_flake_rust() {
  cat > flake.nix <<EOF
{
  description = "${proj_name} rust flake";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
    fenix = {
      url = "github:nix-community/fenix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, flake-utils, fenix, ... }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.\${system};
        rust = with fenix.packages.\${system};
          combine [ stable.toolchain stable.rust-src ];
      in {
        devShells.default = pkgs.mkShell {
          packages = with pkgs; [ rust llvmPackages.bintools ];
          shellHook = ''
            ${write_shell_hook_ps1}
            export CARGO_HOME="\$PWD/.cargo"
          '';
        };
      }
    );
}
EOF
}

write_flake_wasm() {
  cat > flake.nix <<EOF
{
  description = "${proj_name} wasm flake";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
    fenix = {
      url = "github:nix-community/fenix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, flake-utils, fenix, ... }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.\${system};
        rust = with fenix.packages.\${system};
          combine [
            stable.toolchain
            stable.rust-src
            targets.wasm32-unknown-unknown.stable.rust-std
          ];
      in {
        devShells.default = pkgs.mkShell {
          packages = with pkgs; [
            rust llvmPackages.bintools nodejs wasm-pack trunk
          ];
          shellHook = ''
            ${write_shell_hook_ps1}
            export CARGO_HOME="\$PWD/.cargo"
          '';
        };
      }
    );
}
EOF
}

case "$LANG" in
  default) write_flake_default ;;
  rust)    write_flake_rust ;;
  wasm)    write_flake_wasm ;;
  *) echo "Unknown language: $LANG" >&2; usage ;;
esac

: > .gitignore
printf ".cargo/\ntarget/\n" >> .gitignore
[ "$LANG" = "wasm" ] && printf "dist/\npkg/\n" >> .gitignore

[ ! -f .rustfmt.toml ] && printf "tab_spaces = 2\n" > .rustfmt.toml

if [ "$NO_GIT" -eq 0 ] && [ ! -d .git ]; then
  git init
  git add -A
  git commit -m "Initial commit (created by fh)" || true
fi

cat <<EOF

✔ Created flake project '${proj_name}' in: $(pwd)

Notes:
 - Use --no-git to skip git initialization.
 - Use --force to scaffold into non-empty dirs.
EOF

